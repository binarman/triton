============================= test session starts ==============================
platform linux -- Python 3.9.19, pytest-7.3.2, pluggy-1.4.0
rootdir: /triton/python
plugins: shard-0.1.2, flakefinder-1.1.0, cpp-2.3.0, xdist-3.3.1, hypothesis-5.35.1, xdoctest-1.1.0, rerunfailures-14.0
collected 1 item
Running 1 items in this shard

python/test/unit/hopper/test_flashattention.py abs top (1, 26, 2029, 60). Ref: -7.444620132446289e-05, Triton: -0.0148162841796875
ref:  tensor([[[[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [-2.1629e-03,  2.4841e-02, -2.7664e-02,  ..., -2.5742e-02,
           -2.5253e-02, -1.0576e-03],
          [-2.3941e-02, -5.0201e-03,  1.1520e-02,  ..., -1.3329e-02,
            1.4069e-02,  4.7188e-03],
          ...,
          [-4.5276e-04,  1.5106e-03, -7.3910e-04,  ...,  1.8108e-04,
            6.8665e-04,  1.0777e-03],
          [ 3.7098e-03,  4.7684e-05,  2.7800e-04,  ...,  2.2430e-03,
           -1.0910e-03, -9.7036e-04],
          [ 1.0834e-03,  1.0872e-03,  7.7963e-04,  ...,  1.1587e-04,
           -4.5729e-04,  1.4377e-04]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [-6.7749e-02, -4.2053e-02, -3.3600e-02,  ..., -1.6098e-02,
            2.6962e-02,  6.8970e-02],
          [ 1.5297e-02, -4.2605e-04,  2.6321e-03,  ..., -3.1830e-02,
           -1.0406e-02,  1.5688e-03],
          ...,
          [ 2.1219e-04, -3.1090e-03, -2.1877e-03,  ..., -2.1610e-03,
            1.4992e-03,  1.6003e-03],
          [-3.8743e-06, -5.5170e-04,  1.7939e-03,  ..., -4.8676e-03,
           -6.3801e-04,  9.4604e-04],
          [ 1.0176e-03,  6.7663e-04,  5.9795e-04,  ...,  8.9979e-04,
           -6.9666e-04,  8.7500e-04]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [-1.7667e-04, -8.5258e-04, -1.7405e-03,  ...,  1.9157e-04,
           -1.3762e-03, -5.8413e-04],
          [-5.4092e-03, -3.2043e-02, -5.2612e-02,  ...,  8.1406e-03,
           -6.1218e-02, -1.3412e-02],
          ...,
          [ 7.1764e-05,  1.5240e-03, -1.5993e-03,  ...,  3.9268e-04,
           -5.2977e-04, -2.2507e-03],
          [-3.0441e-03,  2.3613e-03, -3.7241e-04,  ...,  1.7614e-03,
           -2.6684e-03, -1.4086e-03],
          [-2.1896e-03,  1.6241e-03,  7.8821e-04,  ..., -3.5119e-04,
           -3.3073e-03,  6.7711e-04]],

         ...,

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 1.5469e-03, -8.5983e-03,  1.4481e-02,  ...,  1.0662e-03,
            1.9045e-03,  5.5466e-03],
          [-1.4130e-02,  2.9541e-02,  6.9618e-03,  ...,  7.9966e-04,
            9.8801e-03, -7.8964e-03],
          ...,
          [-6.0883e-03, -1.9531e-03, -2.2945e-03,  ..., -2.8038e-04,
            1.0127e-04,  1.0405e-03],
          [-1.5306e-04,  8.8167e-04, -2.3174e-03,  ..., -2.3880e-03,
           -1.2550e-03, -4.6730e-04],
          [ 3.1233e-04,  1.4477e-03,  4.9639e-04,  ...,  4.8661e-04,
            8.0061e-04,  1.0996e-03]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [-9.3307e-03, -9.1629e-03, -7.0915e-03,  ..., -7.4387e-03,
           -5.5733e-03, -3.9330e-03],
          [-1.8021e-02, -3.6316e-02, -3.9246e-02,  ...,  1.9699e-02,
           -4.0161e-02,  2.8397e-02],
          ...,
          [ 1.3840e-04, -1.4915e-03,  1.3762e-03,  ...,  4.8752e-03,
            1.2465e-03, -1.4658e-03],
          [ 6.9439e-05,  2.9349e-04, -8.8978e-04,  ..., -8.8453e-04,
           -3.2485e-05, -6.3515e-04],
          [-1.2531e-03, -8.1158e-04, -7.5197e-04,  ..., -2.4104e-04,
           -2.8849e-04,  2.6035e-03]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [-1.2035e-03,  4.2152e-03,  2.4872e-03,  ...,  1.4515e-03,
           -5.3482e-03,  6.1607e-03],
          [-1.3107e-02,  1.5358e-02, -5.3596e-03,  ..., -6.4621e-03,
           -3.0960e-02,  9.8038e-03],
          ...,
          [ 1.4296e-03,  9.4223e-04, -9.4652e-04,  ..., -1.2875e-03,
           -1.3008e-03, -3.3092e-04],
          [ 7.8583e-04,  2.1133e-03,  4.1699e-04,  ...,  6.6233e-04,
           -1.7939e-03,  2.5058e-04],
          [ 1.2569e-03,  1.2627e-03,  1.7672e-03,  ...,  8.6498e-04,
            1.2010e-04,  3.7742e-04]]],


        [[[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 8.9340e-03,  8.8577e-03, -3.5896e-03,  ..., -9.6130e-03,
            3.0851e-04,  6.6032e-03],
          [ 5.8807e-02,  3.8849e-02, -2.6077e-02,  ..., -5.4474e-02,
           -1.2825e-02,  4.6021e-02],
          ...,
          [-1.7476e-04, -1.3189e-03, -2.7008e-03,  ..., -9.4843e-04,
           -2.2526e-03,  1.5354e-03],
          [ 2.2354e-03,  1.4439e-03,  6.8235e-04,  ..., -1.2386e-04,
           -1.7052e-03,  1.2016e-03],
          [-3.0327e-03, -1.2169e-03,  9.9182e-04,  ...,  1.5640e-03,
           -2.9230e-04, -5.7936e-04]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [-1.2558e-02, -2.6657e-02, -5.3482e-03,  ...,  1.2505e-02,
            3.0151e-02, -1.1932e-02],
          [-2.5040e-02, -6.0547e-02, -9.1248e-03,  ...,  1.7151e-02,
            4.5685e-02, -1.2604e-02],
          ...,
          [-1.1225e-03, -5.5850e-05, -9.9087e-04,  ...,  8.7786e-04,
           -2.5272e-03, -1.6797e-04],
          [-7.7057e-04,  9.2411e-04,  2.8610e-03,  ...,  6.8617e-04,
           -1.5068e-03,  1.5249e-03],
          [ 9.8705e-04, -1.0509e-03,  2.4676e-04,  ..., -4.4918e-04,
           -1.5914e-04,  8.3685e-04]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 5.1880e-02,  9.2590e-02, -2.1210e-02,  ..., -3.0426e-02,
            4.6661e-02,  5.1666e-02],
          [-6.2294e-03, -7.2693e-02,  1.3474e-02,  ..., -5.5428e-03,
           -2.6741e-03,  2.8667e-03],
          ...,
          [-1.8244e-03, -2.7084e-03, -1.2817e-03,  ..., -1.0185e-03,
           -1.6079e-03,  2.9507e-03],
          [-1.8950e-03, -7.0667e-04, -1.3113e-04,  ..., -1.5793e-03,
           -2.0707e-04, -1.5306e-03],
          [-1.1892e-03, -6.5756e-04,  2.3997e-04,  ..., -1.3351e-03,
           -9.6846e-04,  7.0906e-04]],

         ...,

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 9.5062e-03,  1.7624e-02, -1.8921e-02,  ..., -6.2683e-02,
            3.3447e-02, -8.2855e-03],
          [ 1.7548e-02, -2.3842e-03, -2.5742e-02,  ...,  2.2079e-02,
           -1.8143e-02,  2.7485e-03],
          ...,
          [-5.9962e-05, -2.2602e-03,  1.7195e-03,  ...,  1.2522e-03,
            1.3123e-03,  4.5466e-04],
          [ 6.4850e-04,  9.7752e-04, -1.1415e-03,  ..., -8.8882e-04,
            9.1934e-04, -1.2553e-04],
          [ 9.3460e-04,  1.3447e-03, -1.6890e-03,  ...,  6.8045e-04,
           -1.5450e-03,  1.2045e-03]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [-5.5161e-03, -7.2266e-02, -2.3712e-02,  ...,  3.0655e-02,
           -3.5973e-03, -1.9188e-03],
          [ 1.0979e-02, -3.3936e-02,  4.6692e-02,  ..., -1.7868e-02,
           -7.5378e-02, -1.2665e-02],
          ...,
          [-1.7190e-04, -3.1614e-04, -8.1635e-04,  ...,  6.9332e-04,
            1.8835e-03, -4.1270e-04],
          [ 1.8902e-03, -1.6851e-03, -1.4007e-04,  ...,  2.3251e-03,
           -7.1812e-04, -2.3949e-04],
          [ 6.7806e-04, -2.7680e-04, -6.1893e-04,  ..., -1.0881e-03,
           -8.9645e-04,  1.6415e-04]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [-2.0874e-02,  3.2318e-02, -1.1879e-02,  ..., -2.7435e-02,
            9.1934e-03, -5.0385e-02],
          [ 1.5020e-03, -3.9053e-04, -2.8515e-04,  ...,  2.3365e-03,
           -5.6744e-04,  8.9264e-03],
          ...,
          [ 6.9237e-04,  1.1396e-03, -1.0729e-03,  ...,  1.3895e-03,
            5.1737e-05,  1.1945e-04],
          [ 9.1732e-05, -1.1415e-03,  1.4505e-03,  ...,  4.9496e-04,
           -7.7581e-04,  2.3377e-04],
          [-5.8937e-04, -3.1395e-03,  1.4200e-03,  ...,  9.8515e-04,
            8.8072e-04, -1.9989e-03]]],


        [[[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [-1.2598e-03,  1.8854e-03,  2.0523e-03,  ...,  1.1425e-03,
           -7.5245e-04, -1.3876e-03],
          [ 6.5117e-03, -5.1193e-03,  8.8739e-04,  ..., -2.3651e-03,
            2.7204e-04,  6.9504e-03],
          ...,
          [-5.5790e-04, -1.3685e-04, -1.0414e-03,  ...,  2.7199e-03,
            1.6499e-03, -2.9716e-03],
          [-2.3575e-03,  3.8958e-04,  2.2602e-03,  ...,  7.3385e-04,
            4.9019e-04,  3.8576e-04],
          [-1.9760e-03, -2.3041e-03, -1.1854e-03,  ..., -3.7956e-04,
            1.4839e-03,  2.9731e-04]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [-3.4332e-02, -2.0905e-02, -2.7496e-02,  ..., -1.9073e-02,
            2.4643e-03,  6.1417e-03],
          [-1.8053e-03,  4.6234e-02, -4.1565e-02,  ..., -1.1194e-01,
           -7.2327e-02, -1.0920e-03],
          ...,
          [ 7.1573e-04,  6.5184e-04, -1.5182e-03,  ..., -2.6207e-03,
           -5.5742e-04,  6.6710e-04],
          [ 9.1171e-04, -3.1519e-04,  9.1267e-04,  ..., -2.1706e-03,
           -4.2200e-04,  2.4354e-04],
          [ 1.6794e-03,  9.6989e-04, -2.8305e-03,  ...,  1.8585e-04,
            6.7711e-04, -1.5059e-03]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [-7.8125e-02,  8.8745e-02, -1.1053e-01,  ..., -1.6678e-02,
            9.9106e-03, -5.5389e-02],
          [-2.9465e-02,  3.3417e-02, -4.2908e-02,  ..., -5.4665e-03,
            3.8338e-03, -2.1027e-02],
          ...,
          [-1.8656e-04,  1.0624e-03, -2.5010e-04,  ..., -9.5367e-04,
           -2.6245e-03,  6.8140e-04],
          [-1.2455e-03, -9.8228e-04, -5.5790e-04,  ...,  6.2764e-05,
            1.0138e-03, -1.6661e-03],
          [-3.7265e-04,  2.5487e-04,  1.6985e-03,  ..., -2.0351e-03,
           -1.3075e-03,  1.5354e-03]],

         ...,

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [-2.2232e-02, -1.6594e-03,  8.4076e-03,  ..., -6.6376e-03,
            2.1759e-02, -7.1533e-02],
          [ 1.8814e-02,  4.0092e-03,  1.7731e-02,  ...,  1.0956e-02,
           -8.7967e-03, -4.8737e-02],
          ...,
          [ 9.4891e-05,  3.4237e-03,  5.1069e-04,  ...,  2.6093e-03,
            2.1191e-03, -1.6146e-03],
          [ 1.7846e-04, -7.4673e-04, -6.2037e-04,  ...,  5.7364e-04,
           -5.0497e-04,  5.3072e-04],
          [-6.4182e-04,  1.4410e-03,  6.7282e-04,  ...,  1.5850e-03,
            1.8682e-03,  5.4312e-04]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 1.8990e-04,  6.0043e-03, -7.2060e-03,  ...,  2.0081e-02,
           -9.2087e-03,  2.2644e-02],
          [ 1.2718e-02, -4.9782e-03,  7.1411e-03,  ...,  1.2939e-02,
           -9.0942e-03, -1.4671e-02],
          ...,
          [-7.5626e-04,  1.5602e-03,  1.6022e-03,  ...,  7.8630e-04,
           -1.3161e-03,  1.0977e-03],
          [-5.5408e-04,  3.4084e-03,  1.7252e-03,  ..., -1.1721e-03,
            8.8835e-04,  5.6219e-04],
          [-5.9843e-04, -1.5059e-03, -1.1139e-03,  ..., -1.9970e-03,
            5.4598e-05,  6.2466e-05]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [-1.1398e-02, -8.9264e-03, -3.1567e-03,  ..., -2.1973e-03,
           -3.7155e-03,  1.9045e-03],
          [-4.8553e-02, -3.9612e-02, -2.7817e-02,  ..., -1.7166e-02,
           -4.6387e-03, -4.6005e-03],
          ...,
          [-2.3067e-04, -9.8884e-05, -2.1286e-03,  ..., -2.6836e-03,
            1.6603e-03, -3.3140e-04],
          [-6.2323e-04, -2.3861e-03,  2.4796e-04,  ...,  1.0805e-03,
           -1.6556e-03, -3.2258e-04],
          [ 3.0804e-04, -1.6565e-03,  2.0485e-03,  ...,  1.2093e-03,
            1.6680e-03,  1.6470e-03]]],


        [[[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [-5.9891e-03,  4.1084e-03,  9.1476e-03,  ...,  1.6165e-03,
            1.2980e-03,  2.3842e-03],
          [ 1.7014e-02, -6.2675e-03, -3.2867e-02,  ..., -1.0590e-02,
           -6.8092e-03, -2.4948e-02],
          ...,
          [ 1.8759e-03,  6.2275e-04, -1.4944e-03,  ...,  2.9182e-04,
            2.7561e-03, -6.6471e-04],
          [ 6.8998e-04, -3.2663e-04,  6.9857e-04,  ...,  1.4286e-03,
           -1.4391e-03,  1.9848e-04],
          [-1.0071e-03, -1.3447e-04,  7.1955e-04,  ...,  3.0565e-04,
           -2.1553e-03,  8.6212e-04]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [-4.1161e-03, -5.9557e-04, -3.0075e-02,  ..., -1.7532e-02,
           -3.8624e-03, -1.1911e-03],
          [ 6.9160e-03, -9.2239e-03, -1.4603e-02,  ...,  1.9150e-02,
            2.3788e-02,  1.5594e-02],
          ...,
          [ 1.8148e-03, -1.8854e-03, -1.2970e-03,  ...,  1.6470e-03,
            2.4891e-03, -1.0687e-04],
          [ 8.4496e-04,  1.9002e-04,  3.3569e-03,  ...,  1.7986e-03,
            2.2926e-03,  1.2255e-03],
          [-2.2945e-03, -6.1703e-04, -1.6651e-03,  ..., -4.0398e-03,
            4.5609e-04,  1.0548e-03]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 2.3384e-03,  1.1856e-02, -6.5660e-04,  ...,  4.3488e-03,
            5.0688e-04,  8.7357e-03],
          [ 3.6011e-02, -4.3564e-03,  7.3303e-02,  ..., -1.1772e-02,
           -3.5004e-02,  3.3234e-02],
          ...,
          [ 4.7827e-04,  1.5478e-03, -1.9102e-03,  ..., -1.6813e-03,
           -2.2602e-03,  8.7738e-04],
          [-1.9798e-03,  1.3936e-04,  1.1539e-03,  ...,  2.0161e-03,
           -2.3854e-04,  1.8120e-03],
          [-1.0872e-03, -1.7557e-03,  1.3552e-03,  ..., -1.1563e-05,
           -2.8062e-04, -8.2064e-04]],

         ...,

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [-1.5884e-02, -1.8860e-02, -3.9558e-03,  ..., -9.9411e-03,
           -2.0523e-02,  2.8168e-02],
          [ 7.0984e-02,  5.6946e-02,  1.7910e-03,  ...,  1.6876e-02,
            4.4922e-02, -1.1414e-01],
          ...,
          [-2.4090e-03, -1.9341e-03, -7.3433e-04,  ..., -3.8171e-04,
           -4.5490e-04,  2.3842e-06],
          [-1.0753e-04, -1.6603e-03, -1.4248e-03,  ..., -2.1057e-03,
            1.4219e-03,  2.0313e-03],
          [-1.0414e-03,  3.2120e-03,  3.2949e-04,  ..., -4.0793e-04,
            9.3222e-04,  8.3506e-05]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 3.3998e-04,  2.8253e-04, -4.5815e-03,  ...,  3.8548e-03,
            5.1451e-04, -1.4811e-03],
          [-2.0615e-02,  1.2794e-02, -1.1237e-01,  ...,  1.0571e-01,
            3.4607e-02, -6.0089e-02],
          ...,
          [-4.2796e-04,  7.7820e-04, -2.1725e-03,  ..., -2.0103e-03,
           -5.6362e-04,  5.0926e-04],
          [ 2.3251e-03,  1.2026e-03,  4.1270e-04,  ..., -2.3022e-03,
           -6.6042e-05,  1.2407e-03],
          [ 1.3151e-03, -5.6553e-04, -2.2945e-03,  ..., -1.1692e-03,
            5.8889e-04,  2.3117e-03]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [-7.2449e-02, -6.3904e-02,  6.2683e-02,  ...,  6.1249e-02,
           -3.1166e-03, -3.3630e-02],
          [ 5.5115e-02,  2.4292e-02, -2.7832e-02,  ..., -1.7960e-02,
           -4.4823e-03,  1.0345e-02],
          ...,
          [-1.2808e-03,  8.4734e-04, -3.6883e-04,  ...,  2.2335e-03,
            6.8808e-04,  2.2297e-03],
          [-2.4223e-03, -3.0766e-03,  3.8981e-04,  ..., -7.3719e-04,
            9.8324e-04, -1.3437e-03],
          [ 1.4715e-03,  1.7300e-03,  3.9635e-03,  ...,  2.6536e-04,
            2.5797e-04,  8.6880e-04]]]], device='cuda:0', dtype=torch.float16)
triton:  tensor([[[[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [-2.3670e-03,  2.4734e-02, -2.7847e-02,  ..., -2.5909e-02,
           -2.5360e-02, -1.1711e-03],
          [-2.3972e-02, -5.0430e-03,  1.1505e-02,  ..., -1.3336e-02,
            1.4069e-02,  4.7035e-03],
          ...,
          [-2.7790e-03, -8.2541e-04, -3.0956e-03,  ..., -2.1992e-03,
           -1.6022e-03, -1.3208e-03],
          [ 2.5024e-03, -1.1225e-03, -9.1267e-04,  ...,  1.0281e-03,
           -2.3079e-03, -2.1439e-03],
          [ 4.6539e-03,  4.6959e-03,  4.2191e-03,  ...,  3.7098e-03,
            3.2196e-03,  3.8128e-03]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [-6.7871e-02, -4.2145e-02, -3.3783e-02,  ..., -1.6205e-02,
            2.6901e-02,  6.8909e-02],
          [ 1.5244e-02, -5.0497e-04,  2.4796e-03,  ..., -3.1952e-02,
           -1.0468e-02,  1.5182e-03],
          ...,
          [-1.7328e-03, -5.1231e-03, -4.1695e-03,  ..., -4.1847e-03,
           -5.2071e-04, -2.9540e-04],
          [ 4.9744e-03,  4.1351e-03,  6.4964e-03,  ..., -1.6820e-04,
            3.7479e-03,  5.6458e-03],
          [ 1.1253e-03,  7.3624e-04,  6.9284e-04,  ...,  9.7370e-04,
           -6.2561e-04,  9.4938e-04]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [-2.1076e-04, -8.7833e-04, -1.7872e-03,  ...,  1.6618e-04,
           -1.4029e-03, -6.2752e-04],
          [-5.4893e-03, -3.2135e-02, -5.2734e-02,  ...,  8.0872e-03,
           -6.1310e-02, -1.3512e-02],
          ...,
          [-1.2665e-03,  3.7551e-06, -2.9030e-03,  ..., -9.4461e-04,
           -1.8873e-03, -3.5362e-03],
          [-2.0657e-03,  3.3989e-03,  6.1369e-04,  ...,  2.7370e-03,
           -1.6623e-03, -3.0708e-04],
          [-4.3716e-03, -4.3416e-04, -1.2932e-03,  ..., -2.3689e-03,
           -5.4855e-03, -1.3981e-03]],

         ...,

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 1.4744e-03, -8.6212e-03,  1.4420e-02,  ...,  9.9659e-04,
            1.8492e-03,  5.4588e-03],
          [-1.4244e-02,  2.9388e-02,  6.8741e-03,  ...,  6.6090e-04,
            9.7504e-03, -8.0261e-03],
          ...,
          [-1.1925e-02, -7.5569e-03, -8.0948e-03,  ..., -6.2294e-03,
           -5.7106e-03, -4.8180e-03],
          [ 5.6267e-04,  1.6851e-03, -1.6193e-03,  ..., -1.6546e-03,
           -5.9795e-04,  2.0981e-04],
          [-2.0638e-03, -9.3412e-04, -1.8215e-03,  ..., -1.9426e-03,
           -1.5430e-03, -1.4009e-03]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [-9.4070e-03, -9.2392e-03, -7.2060e-03,  ..., -7.5073e-03,
           -5.6381e-03, -4.0131e-03],
          [-1.7914e-02, -3.6224e-02, -3.9093e-02,  ...,  1.9821e-02,
           -4.0100e-02,  2.8534e-02],
          ...,
          [ 5.2452e-04, -1.0176e-03,  1.8196e-03,  ...,  5.3139e-03,
            1.7109e-03, -9.3317e-04],
          [ 1.6823e-03,  1.9236e-03,  8.0824e-04,  ...,  9.8705e-04,
            1.5640e-03,  1.0376e-03],
          [ 5.2757e-03,  5.7487e-03,  5.5122e-03,  ...,  6.1150e-03,
            6.0692e-03,  8.9722e-03]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [-1.2074e-03,  4.2114e-03,  2.4796e-03,  ...,  1.4467e-03,
           -5.3482e-03,  6.1493e-03],
          [-1.2985e-02,  1.5434e-02, -5.2605e-03,  ..., -6.3820e-03,
           -3.0869e-02,  9.9411e-03],
          ...,
          [ 2.3403e-03,  1.8196e-03, -7.4685e-05,  ..., -4.8065e-04,
           -4.6849e-04,  5.6076e-04],
          [-5.6801e-03, -4.3526e-03, -6.2408e-03,  ..., -5.9586e-03,
           -8.1711e-03, -6.2256e-03],
          [ 1.0538e-03,  1.0147e-03,  1.5306e-03,  ...,  6.6471e-04,
           -1.0568e-04,  1.5461e-04]]],


        [[[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 8.9111e-03,  8.8272e-03, -3.5992e-03,  ..., -9.6054e-03,
            2.9492e-04,  6.5842e-03],
          [ 5.8807e-02,  3.8849e-02, -2.6123e-02,  ..., -5.4504e-02,
           -1.2863e-02,  4.6021e-02],
          ...,
          [-6.6986e-03, -8.0719e-03, -9.3536e-03,  ..., -7.5912e-03,
           -9.1476e-03, -5.1041e-03],
          [ 7.3099e-04, -8.2076e-05, -7.6628e-04,  ..., -1.6680e-03,
           -3.2330e-03, -4.9353e-04],
          [-4.4746e-03, -2.8343e-03, -6.2704e-04,  ...,  3.6716e-05,
           -1.8387e-03, -2.1515e-03]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [-1.2657e-02, -2.6840e-02, -5.4321e-03,  ...,  1.2321e-02,
            2.9999e-02, -1.2001e-02],
          [-2.5024e-02, -6.0516e-02, -9.1095e-03,  ...,  1.7181e-02,
            4.5746e-02, -1.2589e-02],
          ...,
          [ 1.2732e-03,  2.3785e-03,  1.5354e-03,  ...,  3.2997e-03,
           -2.2018e-04,  2.3460e-03],
          [-2.1648e-03, -4.9210e-04,  1.4610e-03,  ..., -6.4087e-04,
           -2.8267e-03,  1.8394e-04],
          [ 2.1076e-03,  8.3923e-05,  1.4429e-03,  ...,  6.1798e-04,
            1.0338e-03,  2.0237e-03]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 5.1880e-02,  9.2590e-02, -2.1271e-02,  ..., -3.0533e-02,
            4.6661e-02,  5.1697e-02],
          [-6.4468e-03, -7.2754e-02,  1.3283e-02,  ..., -5.7259e-03,
           -2.8305e-03,  2.7390e-03],
          ...,
          [-1.7099e-03, -2.6455e-03, -1.1721e-03,  ..., -8.8596e-04,
           -1.5516e-03,  3.0022e-03],
          [-2.5678e-04,  7.8106e-04,  1.3447e-03,  ..., -1.6665e-04,
            1.2493e-03,  5.2035e-05],
          [ 5.7745e-04,  1.0529e-03,  1.9464e-03,  ...,  3.6430e-04,
            6.6280e-04,  2.4586e-03]],

         ...,

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 9.4910e-03,  1.7609e-02, -1.8951e-02,  ..., -6.2683e-02,
            3.3417e-02, -8.3008e-03],
          [ 1.7517e-02, -2.3899e-03, -2.5681e-02,  ...,  2.2095e-02,
           -1.8127e-02,  2.7523e-03],
          ...,
          [ 5.6305e-03,  3.4218e-03,  7.3509e-03,  ...,  6.9237e-03,
            6.9618e-03,  6.0539e-03],
          [-7.5722e-03, -6.9923e-03, -9.0942e-03,  ..., -9.1705e-03,
           -7.1907e-03, -8.1406e-03],
          [ 3.9253e-03,  4.3793e-03,  1.4706e-03,  ...,  3.6316e-03,
            1.4877e-03,  4.1885e-03]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [-5.5161e-03, -7.2266e-02, -2.3712e-02,  ...,  3.0655e-02,
           -3.5973e-03, -1.9188e-03],
          [ 1.0948e-02, -3.3966e-02,  4.6692e-02,  ..., -1.7883e-02,
           -7.5378e-02, -1.2688e-02],
          ...,
          [-5.7364e-04, -6.9141e-04, -1.2808e-03,  ...,  3.0518e-04,
            1.3037e-03, -8.5878e-04],
          [ 9.9087e-04, -2.3727e-03, -8.9550e-04,  ...,  1.5154e-03,
           -1.4963e-03, -1.0366e-03],
          [-1.9436e-03, -2.9049e-03, -3.3588e-03,  ..., -3.7766e-03,
           -3.7899e-03, -2.4605e-03]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [-2.0660e-02,  3.2471e-02, -1.1673e-02,  ..., -2.7328e-02,
            9.3460e-03, -5.0110e-02],
          [ 1.4544e-03, -4.1747e-04, -3.2926e-04,  ...,  2.3136e-03,
           -5.9843e-04,  8.8806e-03],
          ...,
          [-9.3651e-04, -4.7660e-04, -2.6875e-03,  ..., -2.3496e-04,
           -1.5955e-03, -1.5354e-03],
          [-8.5983e-03, -1.0284e-02, -7.6218e-03,  ..., -8.9035e-03,
           -9.7122e-03, -8.8196e-03],
          [ 3.4428e-03,  8.0109e-04,  5.5046e-03,  ...,  5.1880e-03,
            5.0545e-03,  1.9016e-03]]],


        [[[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [-1.2569e-03,  1.8902e-03,  2.0657e-03,  ...,  1.1539e-03,
           -7.4911e-04, -1.3847e-03],
          [ 6.5041e-03, -5.1155e-03,  8.7881e-04,  ..., -2.3651e-03,
            2.7394e-04,  6.9427e-03],
          ...,
          [-1.1520e-03, -6.2752e-04, -1.5697e-03,  ...,  2.1591e-03,
            1.0996e-03, -3.4599e-03],
          [-3.9787e-03, -1.3342e-03,  5.3644e-04,  ..., -8.7833e-04,
           -1.0939e-03, -1.1930e-03],
          [ 2.9659e-03,  2.7657e-03,  3.9177e-03,  ...,  4.7607e-03,
            6.3744e-03,  5.1689e-03]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [-3.4302e-02, -2.0874e-02, -2.7466e-02,  ..., -1.9043e-02,
            2.4834e-03,  6.1684e-03],
          [-1.7557e-03,  4.6295e-02, -4.1504e-02,  ..., -1.1194e-01,
           -7.2266e-02, -1.0357e-03],
          ...,
          [-2.7447e-03, -2.7180e-03, -4.9591e-03,  ..., -6.0539e-03,
           -3.8013e-03, -2.7637e-03],
          [ 2.5711e-03,  1.3189e-03,  2.5940e-03,  ..., -6.0272e-04,
            1.1272e-03,  1.8835e-03],
          [ 5.3291e-03,  4.7035e-03,  9.8801e-04,  ...,  3.9139e-03,
            4.3335e-03,  2.0351e-03]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [-7.8247e-02,  8.8684e-02, -1.1053e-01,  ..., -1.6769e-02,
            9.8572e-03, -5.5450e-02],
          [-2.9739e-02,  3.3264e-02, -4.3060e-02,  ..., -5.7220e-03,
            3.6793e-03, -2.1225e-02],
          ...,
          [-3.1281e-03, -1.7843e-03, -3.2310e-03,  ..., -3.8261e-03,
           -5.3940e-03, -2.3861e-03],
          [ 4.9362e-03,  5.1651e-03,  5.3444e-03,  ...,  5.9814e-03,
            7.1106e-03,  4.3411e-03],
          [-2.4509e-03, -2.0428e-03, -4.5609e-04,  ..., -4.2496e-03,
           -3.5419e-03, -6.9761e-04]],

         ...,

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [-2.2186e-02, -1.6069e-03,  8.4534e-03,  ..., -6.5727e-03,
            2.1790e-02, -7.1533e-02],
          [ 1.8906e-02,  4.1237e-03,  1.7838e-02,  ...,  1.1101e-02,
           -8.7585e-03, -4.8676e-02],
          ...,
          [ 7.0906e-04,  3.5648e-03,  8.7309e-04,  ...,  3.0518e-03,
            2.4891e-03, -1.2178e-03],
          [ 1.7519e-03,  7.5674e-04,  1.0490e-03,  ...,  2.1458e-03,
            1.0710e-03,  2.1648e-03],
          [-1.5497e-03,  5.4502e-04, -2.2554e-04,  ...,  7.4720e-04,
            1.0433e-03, -2.3901e-04]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 1.2231e-04,  5.9433e-03, -7.2861e-03,  ...,  2.0035e-02,
           -9.2850e-03,  2.2644e-02],
          [ 1.2733e-02, -4.9629e-03,  7.1487e-03,  ...,  1.2978e-02,
           -9.1019e-03, -1.4648e-02],
          ...,
          [ 5.7716e-03,  8.0490e-03,  8.4000e-03,  ...,  7.4196e-03,
            5.1308e-03,  7.4463e-03],
          [-4.6945e-04,  3.4809e-03,  1.7796e-03,  ..., -1.1005e-03,
            9.8419e-04,  6.3133e-04],
          [-3.4008e-03, -4.1847e-03, -3.8223e-03,  ..., -4.7264e-03,
           -2.7580e-03, -2.7218e-03]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [-1.1551e-02, -9.0714e-03, -3.2673e-03,  ..., -2.3308e-03,
           -3.8834e-03,  1.7538e-03],
          [-4.8584e-02, -3.9642e-02, -2.7817e-02,  ..., -1.7166e-02,
           -4.6082e-03, -4.5776e-03],
          ...,
          [ 7.9803e-03,  8.1482e-03,  6.1150e-03,  ...,  5.3520e-03,
            1.0262e-02,  7.6218e-03],
          [ 1.3151e-03, -5.4216e-04,  2.1935e-03,  ...,  3.0174e-03,
            2.7847e-04,  1.5469e-03],
          [ 5.0468e-03,  3.1261e-03,  6.8817e-03,  ...,  5.8212e-03,
            6.2714e-03,  6.3019e-03]]],


        [[[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [-6.0463e-03,  4.0894e-03,  9.1400e-03,  ...,  1.5936e-03,
            1.2779e-03,  2.3613e-03],
          [ 1.7014e-02, -6.2675e-03, -3.2867e-02,  ..., -1.0590e-02,
           -6.8092e-03, -2.4948e-02],
          ...,
          [ 1.9979e-04, -9.1124e-04, -2.9907e-03,  ..., -1.2417e-03,
            1.2712e-03, -2.3174e-03],
          [ 3.7694e-04, -6.6614e-04,  4.3964e-04,  ...,  1.1597e-03,
           -1.7614e-03, -5.9783e-05],
          [-1.8501e-03, -9.8610e-04, -2.6155e-04,  ..., -5.7983e-04,
           -3.0823e-03,  8.1062e-06]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [-4.0779e-03, -5.7745e-04, -3.0029e-02,  ..., -1.7502e-02,
           -3.8433e-03, -1.1797e-03],
          [ 6.9847e-03, -9.1858e-03, -1.4534e-02,  ...,  1.9180e-02,
            2.3819e-02,  1.5617e-02],
          ...,
          [ 3.1719e-03, -5.6028e-04, -7.9453e-05,  ...,  3.0499e-03,
            3.8452e-03,  1.2302e-03],
          [-1.9703e-03, -2.6245e-03,  5.7268e-04,  ..., -1.1082e-03,
           -7.0858e-04, -1.5955e-03],
          [-1.4477e-03,  2.9707e-04, -6.6900e-04,  ..., -3.0994e-03,
            1.2512e-03,  1.8816e-03]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 2.3289e-03,  1.1848e-02, -6.6519e-04,  ...,  4.3335e-03,
            4.9591e-04,  8.7280e-03],
          [ 3.6041e-02, -4.3144e-03,  7.3303e-02,  ..., -1.1734e-02,
           -3.4973e-02,  3.3264e-02],
          ...,
          [ 1.4696e-03,  2.5787e-03, -8.2684e-04,  ..., -7.7009e-04,
           -1.1892e-03,  1.9531e-03],
          [ 9.4986e-04,  2.9259e-03,  4.0016e-03,  ...,  4.8294e-03,
            2.5291e-03,  4.6921e-03],
          [-2.9373e-04, -8.0872e-04,  2.1210e-03,  ...,  7.8392e-04,
            6.8188e-04,  1.2022e-04]],

         ...,

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [-1.5930e-02, -1.8890e-02, -3.9825e-03,  ..., -9.9640e-03,
           -2.0554e-02,  2.8152e-02],
          [ 7.0923e-02,  5.6915e-02,  1.7519e-03,  ...,  1.6861e-02,
            4.4891e-02, -1.1420e-01],
          ...,
          [ 4.1246e-04,  1.0147e-03,  2.0885e-03,  ...,  2.3861e-03,
            2.3746e-03,  3.0727e-03],
          [-5.7716e-03, -7.3814e-03, -7.1068e-03,  ..., -7.7667e-03,
           -4.1885e-03, -3.5515e-03],
          [-3.5419e-03,  6.1512e-04, -2.0771e-03,  ..., -2.8877e-03,
           -1.6050e-03, -2.4071e-03]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 3.0255e-04,  2.5272e-04, -4.5433e-03,  ...,  3.7746e-03,
            4.8685e-04, -1.5011e-03],
          [-2.0554e-02,  1.2840e-02, -1.1237e-01,  ...,  1.0577e-01,
            3.4668e-02, -6.0059e-02],
          ...,
          [ 5.0497e-04,  1.7214e-03, -1.2779e-03,  ..., -1.1034e-03,
            3.2663e-04,  1.4391e-03],
          [ 2.8381e-03,  1.7967e-03,  1.0347e-03,  ..., -1.8101e-03,
            5.5838e-04,  1.8358e-03],
          [ 1.1797e-03, -6.7806e-04, -2.5063e-03,  ..., -1.3189e-03,
            4.1986e-04,  2.1381e-03]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [-7.2327e-02, -6.3843e-02,  6.2805e-02,  ...,  6.1371e-02,
           -2.9716e-03, -3.3508e-02],
          [ 5.5084e-02,  2.4261e-02, -2.7786e-02,  ..., -1.7929e-02,
           -4.4708e-03,  1.0338e-02],
          ...,
          [ 2.1915e-03,  4.2076e-03,  2.9697e-03,  ...,  5.6000e-03,
            4.1771e-03,  5.6725e-03],
          [-1.5764e-03, -2.2316e-03,  1.2302e-03,  ...,  3.9935e-05,
            1.8463e-03, -5.3024e-04],
          [-1.0538e-04,  7.1347e-05,  2.3518e-03,  ..., -1.2627e-03,
           -1.2407e-03, -7.2002e-04]]]], device='cuda:0', dtype=torch.float16)
F

=================================== FAILURES ===================================
____________________________ test_op[4-48-2048-64] _____________________________

Z = 4, H = 48, N_CTX = 2048, D_HEAD = 64, dtype = torch.float16

    @pytest.mark.parametrize('Z, H, N_CTX, D_HEAD', [
        (4, 48, 128, 64),
        (4, 48, 256, 64),
        (4, 48, 512, 64),
        (4, 48, 1024, 64),
        (4, 48, 2048, 64),
        (4, 48, 4096, 64),
        #  (4, 48, 8192, 64), out of memory
    ])
    @pytest.mark.skipif(torch.cuda.get_device_capability()[0] < 9, reason="requires arch 9+")
    def test_op(Z, H, N_CTX, D_HEAD, dtype=torch.float16):
        torch.manual_seed(20)
        q = torch.empty((Z, H, N_CTX, D_HEAD), dtype=dtype, device="cuda").normal_(mean=0.1, std=0.2).requires_grad_()
        k = torch.empty((Z, H, N_CTX, D_HEAD), dtype=dtype, device="cuda").normal_(mean=0.4, std=0.2).requires_grad_()
        v = torch.empty((Z, H, N_CTX, D_HEAD), dtype=dtype, device="cuda").normal_(mean=0.3, std=0.2).requires_grad_()
        sm_scale = 0.2
        dout = torch.randn_like(q)
        # reference implementation
        M = torch.tril(torch.ones((N_CTX, N_CTX), device="cuda"))
        p = torch.matmul(q, k.transpose(2, 3)) * sm_scale
        for z in range(Z):
            for h in range(H):
                p[:, :, M == 0] = float("-inf")
        p = torch.softmax(p.float(), dim=-1).half()
        # p = torch.exp(p)
        ref_out = torch.matmul(p, v)
        ref_out.backward(dout)
        ref_dv, v.grad = v.grad.clone(), None
        ref_dk, k.grad = k.grad.clone(), None
        ref_dq, q.grad = q.grad.clone(), None
        # triton implementation
        tri_out = attention(q, k, v, sm_scale)
        # print(ref_out)
        # print(tri_out)
        tri_out.backward(dout)
        tri_dv, v.grad = v.grad.clone(), None
        tri_dk, k.grad = k.grad.clone(), None
        tri_dq, q.grad = q.grad.clone(), None
        # compare
        torch.testing.assert_close(ref_out, tri_out, atol=1e-2, rtol=0)
        print(f"abs top (1, 26, 2029, 60). Ref: {ref_dq[1, 26, 2029, 60]}, Triton: {tri_dq[1, 26, 2029, 60]}")
        print("ref: ", ref_dq)
        print("triton: ", tri_dq)
>       torch.testing.assert_close(ref_dq, tri_dq, atol=1e-2, rtol=0)
E       AssertionError: Tensor-likes are not close!
E
E       Mismatched elements: 3202 / 25165824 (0.0%)
E       Greatest absolute difference: 0.014739990234375 at index (1, 26, 2029, 60) (up to 0.01 allowed)
E       Greatest relative difference: 1.8310546875 at index (1, 18, 1953, 55) (up to 0 allowed)

python/test/unit/hopper/test_flashattention.py:404: AssertionError
=========================== short test summary info ============================
FAILED python/test/unit/hopper/test_flashattention.py::test_op[4-48-2048-64] - AssertionError: Tensor-likes are not close!

Mismatched elements: 3202 / 25165824 (0.0%)
Greatest absolute difference: 0.014739990234375 at index (1, 26, 2029, 60) (up to 0.01 allowed)
Greatest relative difference: 1.8310546875 at index (1, 18, 1953, 55) (up to 0 allowed)
============================== 1 failed in 6.80s ===============================
